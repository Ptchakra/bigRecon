#!/bin/bash
subdomain_file=$1
output_file=$2
function enumIP() {
	/usr/src/app/tools/massdns/bin/massdns -t A -o S -s 5000 -w $output_file/massdns.out -r /usr/src/app/google.txt --root $subdomain_file
	sleep 1
	cat $output_file/massdns.out|awk '{print $3}' |sort -u |uniq| grep -oE "\b([0-9]{1,3}\.){3}[0-9]{1,3}\b"|cf-check > $output_file/get-ip.txt
	sleep 1
	# nmap 
	/usr/src/app/tools/masscan/bin/masscan -iL $output_file/get-ip.txt -p 1-65535 --max-rate 5000 -sS -Pn --open -oG $output_file/masscan.gnmap
	sleep 5
	cat $output_file/masscan.gnmap| grep Host | awk '{print $4,$7}' | sed 's@/.*@@' | sort -t' ' -n -k2 | awk -F' ' -v OFS=' ' '{x=$1;$1="";a[x]=a[x]","$0}END{for(x in a) print x,a[x]}' | sed 's/, /,/g' | sed 's/ ,/ /' | sort -V -k1 | cut -d " " -f1 > $output_file/HOSTS
	sleep 1
	cat $output_file/masscan.gnmap| grep Host | awk '{print $4,$7}' | sed 's@/.*@@' | sort -t' ' -n -k2 | awk -F' ' -v OFS=' ' '{x=$1;$1="";a[x]=a[x]","$0}END{for(x in a) print x,a[x]}' | sed 's/, /,/g' | sed 's/ ,/ /' | sort -V -k1 | cut -d " " -f2 > $output_file/OPEN_PORTS
	awk '{if(length($0) > 100){$0="22,80,443,8080,8888,9999,8808,7071,8443,4443,6443" } ; print $0}' $output_file/OPEN_PORTS > $output_file/PORTS
	paste -d "\t" $output_file/HOSTS $output_file/OPEN_PORTS > $output_file/MAP_HOSTS_PORTS
	python3 /usr/src/app/tools/parseMasscanToHost.py $output_file/MAP_HOSTS_PORTS >> $output_file/map-hosts.txt
	cat $output_file/map-hosts.txt| httpx -timeout 20 -threads 30 -silent -H "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/83.0.4103.106 Safari/537.36" -follow-redirects -o $output_file/ip-alive.txt
	sleep 5
	cat $output_file/ip-alive.txt |sort |uniq >> $output_file/alive_subdomain.txt
}
enumIP
